const translations = {
  en: {
    navPlay: "Go to Game",
    eyebrow: "Standards = Safety + Order + Clarity",
    heroTitle: "What is DIN? Why does it matter in daily life?",
    heroLead:
      "DIN develops standards that help products become safer, clearer, and more compatible. Explore DIN on this site, then catch the wrong labels in the mini game!",
    startGame: "Start Game",
    learnMore: "Learn First",
    badge1: "For ages 10-18",
    badge2: "Learning with mini game",
    badge3: "TR / DE / EN support",
    visualCaption: "Checking...",
    whatIsDinTitle: "What does DIN do?",
    whatIsDinText:
      "DIN (Deutsches Institut fur Normung) helps make products and information more understandable, safer, and compatible by developing standards in many areas.",
    kp1: "Supports shared understanding of the same symbols and signs.",
    kp2: "Provides common rules that strengthen safety and quality.",
    kp3: "Reduces confusion in everyday life.",
    dailyLifeTitle: "DIN in everyday life",
    cardSafetyTitle: "Safety",
    cardSafetyText: "Warnings, symbols, and measurements become clearer.",
    cardFitTitle: "Compatibility",
    cardFitText: "Parts and information work better together.",
    cardClarityTitle: "Clarity",
    cardClarityText: "Labels and signs are easier to read.",
    exampleTitle: "Where do we see it?",
    ex1: "Product labels with ingredient and warning information",
    ex2: "Technical drawings and dimensions",
    ex3: "Safety signs and symbols",
    ex4: "Order in schools, labs, and production areas",
    gameEyebrow: "Mini Game",
    gameTitle: "Catch the Wrong Label",
    gameSubtitle: "Goal: Move the yellow recycling bag with the left/right arrow keys and catch faulty labels.",
    startRound: "Start",
    resetRound: "Reset",
    scoreLabel: "Score",
    timeLabel: "Time",
    comboLabel: "Combo",
    arenaHint: "Press Start, move the yellow bag with left/right arrows, and sort the falling bottles.",
    rulesTitle: "Rules",
    rule1: "Catch faulty label in the yellow bag: +10 points",
    rule2: "Catch correct label by mistake: -5 points",
    rule3: "Miss a faulty label: -8 points",
    rule4: "Use left/right arrow keys to move the bag",
    factTitle: "DIN Fact",
    factDefault: "Standards help different people understand information in a similar way.",
    legendTitle: "Legend",
    legendGood: "Neat / correct label",
    legendBad: "Faulty / incomplete label",
    resultEyebrow: "Round Complete",
    resultTitleDefault: "Standard Hunter!",
    playAgain: "Play Again",
    footerText: "Educational concept demo â€¢ A mini experience to spark curiosity about DIN",
    ariaGood: "Product with correct label",
    ariaBad: "Product with wrong label",
    scorePopupPlus: "+{value}",
    scorePopupMinus: "{value}",
    comboBonusText: "Combo Bonus +{value}",
    factEventGood: "Great! You caught a faulty label. Standards help reduce the risk of wrong information.",
    factEventBadClick: "Careful! You sorted a correctly labeled bottle into the yellow bag. Catch the faulty ones.",
    factEventMissBad: "Missed! Incomplete or confusing labels can cause safety and clarity problems.",
    factEventCombo: "Awesome streak! Regular checks are important in quality control.",
    factEventStart: "Round started. Move the yellow bag and catch only faulty labels.",
    resultScoreText: "Your total score: {score}",
    resultGradeLow: "Beginner detective. Look at the labels a little more carefully.",
    resultGradeMid: "Nice work! You are starting to understand the idea of standards.",
    resultGradeHigh: "Very good! You spot label errors quickly.",
    resultGradeTop: "Excellent! You are a real DIN Detective.",
    resultMoodLow: "You can catch more mistakes next round. Keep going!",
    resultMoodMid: "Good pace! Your attention is getting stronger.",
    resultMoodHigh: "Great performance! Fast and careful play.",
    resultMoodTop: "Celebration time! You scanned label mistakes like a pro.",
    resultTitleLow: "New Detective",
    resultTitleMid: "Sharp Eye",
    resultTitleHigh: "Standard Hunter",
    resultTitleTop: "DIN Master",
    toggleInfoShow: "Show Info Panel",
    toggleInfoHide: "Hide Info Panel",
    factList: [
      "Standards support more consistent information on labels.",
      "When symbols are understood consistently, safety improves.",
      "Compatible sizes and formats can reduce errors in use and production.",
      "DIN helps create a common language across many sectors."
    ]
  },
  tr: {
    navPlay: "Oyuna GeÃ§",
    eyebrow: "Standartlar = GÃ¼ven + DÃ¼zen + KolaylÄ±k",
    heroTitle: "DIN nedir? GÃ¼nlÃ¼k hayatta neden Ã¶nemlidir?",
    heroLead:
      "DIN, Ã¼rÃ¼nlerin daha gÃ¼venli, anlaÅŸÄ±lÄ±r ve uyumlu olmasÄ±na yardÄ±mcÄ± olan standartlar geliÅŸtirir. Bu siteyle DIN'i keÅŸfet, sonra mini oyunda yanlÄ±ÅŸ etiketleri yakala!",
    startGame: "Oyunu BaÅŸlat",
    learnMore: "Ã–nce Ã–ÄŸren",
    badge1: "10-18 yaÅŸ iÃ§in",
    badge2: "Mini oyunlu Ã¶ÄŸrenme",
    badge3: "TR / DE destekli",
    visualCaption: "Kontrol ediliyor...",
    whatIsDinTitle: "DIN ne yapar?",
    whatIsDinText:
      "DIN (Deutsches Institut fÃ¼r Normung), birÃ§ok alanda standartlar geliÅŸtirerek Ã¼rÃ¼nlerin ve bilgilerin daha anlaÅŸÄ±lÄ±r, gÃ¼venli ve uyumlu olmasÄ±na katkÄ± saÄŸlar.",
    kp1: "AynÄ± sembol ve iÅŸaretlerin herkesÃ§e anlaÅŸÄ±lmasÄ±nÄ± destekler.",
    kp2: "GÃ¼venlik ve kaliteyi gÃ¼Ã§lendiren ortak kurallar saÄŸlar.",
    kp3: "GÃ¼nlÃ¼k yaÅŸamda karÄ±ÅŸÄ±klÄ±ÄŸÄ± azaltÄ±r.",
    dailyLifeTitle: "GÃ¼nlÃ¼k hayatta DIN etkisi",
    cardSafetyTitle: "GÃ¼venlik",
    cardSafetyText: "UyarÄ±lar, semboller ve Ã¶lÃ§Ã¼ler daha net olur.",
    cardFitTitle: "Uyumluluk",
    cardFitText: "ParÃ§alar ve bilgiler birlikte daha iyi Ã§alÄ±ÅŸÄ±r.",
    cardClarityTitle: "AnlaÅŸÄ±lÄ±rlÄ±k",
    cardClarityText: "Etiketler ve iÅŸaretler daha kolay okunur.",
    exampleTitle: "Nerelerde gÃ¶rÃ¼rÃ¼z?",
    ex1: "ÃœrÃ¼n etiketlerinde iÃ§erik ve uyarÄ± bilgileri",
    ex2: "Teknik Ã§izimler ve Ã¶lÃ§Ã¼lendirmeler",
    ex3: "GÃ¼venlik iÅŸaretleri ve semboller",
    ex4: "Okul, laboratuvar ve Ã¼retim alanlarÄ±ndaki dÃ¼zen",
    gameEyebrow: "Mini Oyun",
    gameTitle: "YanlÄ±ÅŸ Etiketi Yakala",
    gameSubtitle: "AmaÃ§: SarÄ± torbayÄ± saÄŸ-sol ok tuÅŸlarÄ±yla hareket ettir ve hatalÄ± etiketli ÅŸiÅŸeleri yakala.",
    startRound: "BaÅŸlat",
    resetRound: "SÄ±fÄ±rla",
    scoreLabel: "Puan",
    timeLabel: "SÃ¼re",
    comboLabel: "Seri",
    arenaHint: "BaÅŸlat'a bas, sarÄ± torbayÄ± saÄŸ-sol oklarla hareket ettir ve dÃ¼ÅŸen ÅŸiÅŸeleri ayÄ±kla.",
    rulesTitle: "Kurallar",
    rule1: "HatalÄ± etiketi sarÄ± torbada yakala: +10 puan",
    rule2: "DoÄŸru etiketi yanlÄ±ÅŸ yakala: -5 puan",
    rule3: "HatalÄ± etiketi kaÃ§Ä±rma: -8 puan",
    rule4: "SarÄ± torbayÄ± saÄŸ-sol ok tuÅŸlarÄ±yla hareket ettir",
    factTitle: "DIN Bilgisi",
    factDefault: "Standartlar, farklÄ± insanlarÄ±n aynÄ± bilgiyi aynÄ± ÅŸekilde anlamasÄ±na yardÄ±mcÄ± olur.",
    legendTitle: "Ä°ÅŸaretler",
    legendGood: "DÃ¼zenli / doÄŸru etiket",
    legendBad: "HatalÄ± / eksik etiket",
    resultEyebrow: "Tur TamamlandÄ±",
    resultTitleDefault: "Standart AvcÄ±sÄ±!",
    playAgain: "Tekrar Oyna",
    footerText: "EÄŸitim amaÃ§lÄ± hazÄ±rlanmÄ±ÅŸ tanÄ±tÄ±m konsepti â€¢ DIN hakkÄ±nda merak uyandÄ±rmak iÃ§in mini deneyim",
    ariaGood: "DoÄŸru etiketli Ã¼rÃ¼n",
    ariaBad: "YanlÄ±ÅŸ etiketli Ã¼rÃ¼n",
    scorePopupPlus: "+{value}",
    scorePopupMinus: "{value}",
    comboBonusText: "Bonus Seri +{value}",
    factEventGood: "Harika! HatalÄ± etiketi yakaladÄ±n. Standartlar, yanlÄ±ÅŸ bilgi riskini azaltmaya yardÄ±mcÄ± olur.",
    factEventBadClick: "Dikkat! DoÄŸru etiketli bir ÅŸiÅŸeyi sarÄ± torbaya aldÄ±n. Bu oyunda hatalÄ± olanlarÄ± yakalamalÄ±sÄ±n.",
    factEventMissBad: "KaÃ§Ä±rdÄ±n! Eksik veya karÄ±ÅŸÄ±k etiketler gÃ¼venlik ve anlaÅŸÄ±lÄ±rlÄ±k sorununa yol aÃ§abilir.",
    factEventCombo: "SÃ¼per seri! DÃ¼zenli kontrol yapmak kalite denetiminde Ã§ok Ã¶nemlidir.",
    factEventStart: "Tur baÅŸladÄ±. SarÄ± torbayÄ± hareket ettir ve sadece hatalÄ± etiketleri yakala.",
    resultScoreText: "Toplam puanÄ±n: {score}",
    resultGradeLow: "BaÅŸlangÄ±Ã§ seviyesi dedektif. Etiketleri biraz daha dikkatli incele.",
    resultGradeMid: "Ä°yi iÅŸ! Standart mantÄ±ÄŸÄ±nÄ± anlamaya baÅŸladÄ±n.",
    resultGradeHigh: "Ã‡ok iyi! Etiket hatalarÄ±nÄ± hÄ±zlÄ±ca fark ettin.",
    resultGradeTop: "MÃ¼kemmel! GerÃ§ek bir DIN Dedektifisin.",
    resultMoodLow: "Bir sonraki turda daha Ã§ok hata yakalayabilirsin. Devam!",
    resultMoodMid: "GÃ¼zel tempo! Dikkatin giderek gÃ¼Ã§leniyor.",
    resultMoodHigh: "SÃ¼per performans! HÄ±zlÄ± ve dikkatli oynadÄ±n.",
    resultMoodTop: "Kutlama zamanÄ±! Etiket hatalarÄ±nÄ± adeta taradÄ±n.",
    resultTitleLow: "Yeni BaÅŸlayan Dedektif",
    resultTitleMid: "Dikkatli GÃ¶z",
    resultTitleHigh: "Standart AvcÄ±sÄ±",
    resultTitleTop: "DIN UstasÄ±",
    toggleInfoShow: "Bilgi Panelini AÃ§",
    toggleInfoHide: "Bilgi Panelini Gizle",
    factList: [
      "Standartlar, Ã¼rÃ¼n etiketlerinde bilgilerin daha tutarlÄ± verilmesini destekler.",
      "AynÄ± sembolÃ¼n herkes tarafÄ±ndan benzer ÅŸekilde anlaÅŸÄ±lmasÄ± gÃ¼venliÄŸi artÄ±rÄ±r.",
      "Ã–lÃ§Ã¼ ve formatlarda uyum, Ã¼retimde ve kullanÄ±mda hatalarÄ± azaltabilir.",
      "DIN birÃ§ok farklÄ± sektÃ¶rde ortak dil oluÅŸturmaya yardÄ±mcÄ± olur."
    ]
  },
  de: {
    navPlay: "Zum Spiel",
    eyebrow: "Standards = Sicherheit + Ordnung + Klarheit",
    heroTitle: "Was ist DIN? Warum ist es im Alltag wichtig?",
    heroLead:
      "DIN entwickelt Standards, damit Produkte sicherer, verstÃ¤ndlicher und kompatibler werden. Entdecke DIN auf dieser Seite und fange dann im Mini-Spiel die falschen Etiketten!",
    startGame: "Spiel Starten",
    learnMore: "Erst Lernen",
    badge1: "FÃ¼r 10-18 Jahre",
    badge2: "Lernen mit Mini-Spiel",
    badge3: "TR / DE verfÃ¼gbar",
    visualCaption: "Wird geprÃ¼ft...",
    whatIsDinTitle: "Was macht DIN?",
    whatIsDinText:
      "DIN (Deutsches Institut fÃ¼r Normung) trÃ¤gt mit Standards dazu bei, dass Produkte und Informationen verstÃ¤ndlicher, sicherer und besser kompatibel sind.",
    kp1: "UnterstÃ¼tzt, dass Symbole und Zeichen einheitlich verstanden werden.",
    kp2: "Schafft gemeinsame Regeln fÃ¼r Sicherheit und QualitÃ¤t.",
    kp3: "Reduziert Verwirrung im Alltag.",
    dailyLifeTitle: "DIN im Alltag",
    cardSafetyTitle: "Sicherheit",
    cardSafetyText: "Warnhinweise, Symbole und MaÃŸe werden klarer.",
    cardFitTitle: "KompatibilitÃ¤t",
    cardFitText: "Teile und Informationen funktionieren besser zusammen.",
    cardClarityTitle: "VerstÃ¤ndlichkeit",
    cardClarityText: "Etiketten und Zeichen sind leichter lesbar.",
    exampleTitle: "Wo sieht man das?",
    ex1: "Produktetiketten mit Inhalts- und Warninformationen",
    ex2: "Technische Zeichnungen und BemaÃŸungen",
    ex3: "Sicherheitszeichen und Symbole",
    ex4: "Ordnung in Schule, Labor und Produktion",
    gameEyebrow: "Mini-Spiel",
    gameTitle: "Falsches Etikett fangen",
    gameSubtitle: "Ziel: Bewege den gelben Sack mit den Pfeiltasten links/rechts und fange fehlerhafte Etiketten.",
    startRound: "Start",
    resetRound: "ZurÃ¼cksetzen",
    scoreLabel: "Punkte",
    timeLabel: "Zeit",
    comboLabel: "Serie",
    arenaHint: "DrÃ¼cke Start, bewege den gelben Sack mit den Pfeiltasten und sortiere die fallenden Flaschen.",
    rulesTitle: "Regeln",
    rule1: "Fehlerhaftes Etikett im gelben Sack fangen: +10 Punkte",
    rule2: "Korrektes Etikett aus Versehen fangen: -5 Punkte",
    rule3: "Fehlerhaftes Etikett verpassen: -8 Punkte",
    rule4: "Bewege den Sack mit den Pfeiltasten links/rechts",
    factTitle: "DIN-Wissen",
    factDefault: "Standards helfen, dass verschiedene Menschen Informationen auf Ã¤hnliche Weise verstehen.",
    legendTitle: "Hinweise",
    legendGood: "Ordentlich / korrekt etikettiert",
    legendBad: "Fehlerhaft / unvollstÃ¤ndig etikettiert",
    resultEyebrow: "Runde beendet",
    resultTitleDefault: "Standard-JÃ¤ger!",
    playAgain: "Nochmal spielen",
    footerText: "Lernorientiertes Konzept â€¢ Mini-Erlebnis, um Interesse an DIN zu wecken",
    ariaGood: "Produkt mit korrektem Etikett",
    ariaBad: "Produkt mit falschem Etikett",
    scorePopupPlus: "+{value}",
    scorePopupMinus: "{value}",
    comboBonusText: "Serienbonus +{value}",
    factEventGood: "Gut gemacht! Du hast ein falsches Etikett erkannt. Standards helfen, falsche Informationen zu vermeiden.",
    factEventBadClick: "Achtung! Du hast eine korrekt etikettierte Flasche in den gelben Sack sortiert. Fange nur die fehlerhaften.",
    factEventMissBad: "Verpasst! Unklare oder unvollstÃ¤ndige Etiketten kÃ¶nnen zu Sicherheitsproblemen fÃ¼hren.",
    factEventCombo: "Starke Serie! RegelmÃ¤ÃŸige Kontrolle ist in der QualitÃ¤tssicherung sehr wichtig.",
    factEventStart: "Runde gestartet. Bewege den gelben Sack und fange nur fehlerhafte Etiketten.",
    resultScoreText: "Deine Gesamtpunktzahl: {score}",
    resultGradeLow: "Einsteiger-Detektiv. Schau die Etiketten noch etwas genauer an.",
    resultGradeMid: "Gut gemacht! Du verstehst die Idee von Standards schon besser.",
    resultGradeHigh: "Sehr gut! Du erkennst Etikettfehler ziemlich schnell.",
    resultGradeTop: "Perfekt! Du bist ein echter DIN-Detektiv.",
    resultMoodLow: "In der nÃ¤chsten Runde findest du noch mehr Fehler. Weiter so!",
    resultMoodMid: "Gutes Tempo! Dein Blick wird immer schÃ¤rfer.",
    resultMoodHigh: "Starke Leistung! Schnell und aufmerksam gespielt.",
    resultMoodTop: "Zeit zum Feiern! Du hast Etikettfehler blitzschnell erkannt.",
    resultTitleLow: "AnfÃ¤nger-Detektiv",
    resultTitleMid: "Scharfer Blick",
    resultTitleHigh: "Standard-JÃ¤ger",
    resultTitleTop: "DIN-Profi",
    toggleInfoShow: "Infobereich anzeigen",
    toggleInfoHide: "Infobereich ausblenden",
    factList: [
      "Standards unterstÃ¼tzen eine einheitlichere Darstellung von Informationen auf Etiketten.",
      "Wenn Symbole einheitlich verstanden werden, steigt die Sicherheit.",
      "Kompatible MaÃŸe und Formate kÃ¶nnen Fehler in Nutzung und Produktion verringern.",
      "DIN hilft in vielen Bereichen dabei, eine gemeinsame Sprache zu schaffen."
    ]
  }
};

const els = {
  topbar: document.querySelector(".topbar"),
  langButtons: document.querySelectorAll(".lang-btn"),
  startBtn: document.getElementById("startBtn"),
  resetBtn: document.getElementById("resetBtn"),
  playAgainBtn: document.getElementById("playAgainBtn"),
  scoreValue: document.getElementById("scoreValue"),
  timeValue: document.getElementById("timeValue"),
  comboValue: document.getElementById("comboValue"),
  arena: document.getElementById("gameArena"),
  arenaHint: document.querySelector(".arena-hint"),
  catchBag: document.getElementById("catchBag"),
  bagCollected: document.getElementById("bagCollected"),
  gameSide: document.getElementById("gameSide"),
  toggleInfoBtn: document.getElementById("toggleInfoBtn"),
  factText: document.getElementById("factText"),
  factBadge: document.getElementById("factBadge"),
  resultPanel: document.getElementById("resultPanel"),
  resultCard: document.querySelector(".result-card"),
  resultVisual: document.getElementById("resultVisual"),
  resultEmoji: document.getElementById("resultEmoji"),
  resultTitle: document.getElementById("resultTitle"),
  resultScoreText: document.getElementById("resultScoreText"),
  resultMoodText: document.getElementById("resultMoodText"),
  resultGradeText: document.getElementById("resultGradeText")
};

const game = {
  lang: "en",
  running: false,
  score: 0,
  timeLeft: 90,
  combo: 0,
  elapsed: 0,
  spawnAccumulator: 0,
  secondAccumulator: 0,
  rafId: null,
  lastTs: 0,
  items: [],
  nextId: 1,
  factIndex: 0,
  lastFactKey: "factDefault",
  infoPanelOpen: true,
  keys: { left: false, right: false },
  player: { x: 0, speed: 360, width: 132, height: 82 },
  bagStored: []
};

function t(key) {
  return translations[game.lang][key] ?? key;
}

function formatText(template, values = {}) {
  return template.replace(/\{(\w+)\}/g, (_, k) => String(values[k] ?? ""));
}

function setLanguage(lang) {
  game.lang = lang;
  document.documentElement.lang = lang;
  document.querySelectorAll("[data-i18n]").forEach((node) => {
    const key = node.dataset.i18n;
    if (key && translations[lang][key]) {
      node.textContent = translations[lang][key];
    }
  });

  els.langButtons.forEach((btn) => {
    btn.classList.toggle("is-active", btn.dataset.lang === lang);
  });

  updateFactDisplayByKey(game.lastFactKey);
  refreshResultTexts();
  updateStatsUI();
  updateItemAriaLabels();
  updateInfoToggleLabel();
}

function updateStatsUI() {
  els.scoreValue.textContent = String(game.score);
  els.timeValue.textContent = String(game.timeLeft);
  els.comboValue.textContent = String(game.combo);
}

function updateFactDisplay(text, badgeText) {
  els.factText.textContent = text;
  els.factBadge.textContent = badgeText;
}

function updateFactDisplayByKey(key) {
  if (!key) {
    const list = translations[game.lang].factList;
    updateFactDisplay(list[game.factIndex] ?? t("factDefault"), `#${game.factIndex + 1}`);
    game.lastFactKey = "";
    return;
  }
  game.lastFactKey = key;
  if (key === "factDefault") {
    updateFactDisplay(t("factDefault"), `#${game.factIndex + 1}`);
    return;
  }
  updateFactDisplay(t(key), `#${game.factIndex + 1}`);
}

function cycleFact() {
  const list = translations[game.lang].factList;
  game.factIndex = (game.factIndex + 1) % list.length;
  updateFactDisplay(list[game.factIndex], `#${game.factIndex + 1}`);
  game.lastFactKey = "";
}

function showEventFact(key) {
  updateFactDisplayByKey(key);
  window.clearTimeout(showEventFact.timer);
  showEventFact.timer = window.setTimeout(() => {
    cycleFact();
  }, 1400);
}

function clearArenaItems() {
  game.items.forEach((item) => item.el.remove());
  game.items = [];
}

function resetState() {
  game.running = false;
  game.score = 0;
  game.timeLeft = 90;
  game.combo = 0;
  game.elapsed = 0;
  game.spawnAccumulator = 0;
  game.secondAccumulator = 0;
  game.lastTs = 0;
  game.keys.left = false;
  game.keys.right = false;
  if (game.rafId) {
    cancelAnimationFrame(game.rafId);
    game.rafId = null;
  }
  clearArenaItems();
  els.resultPanel.hidden = true;
  els.arenaHint.hidden = false;
  game.factIndex = 0;
  game.lastFactKey = "factDefault";
  clearBagCollected();
  resetBagPosition();
  updateFactDisplayByKey("factDefault");
  updateStatsUI();
}

function setInfoPanelOpen(open) {
  game.infoPanelOpen = open;
  if (els.gameSide) {
    els.gameSide.hidden = !open;
  }
  if (els.toggleInfoBtn) {
    els.toggleInfoBtn.setAttribute("aria-expanded", String(open));
  }
  updateInfoToggleLabel();
}

function updateInfoToggleLabel() {
  if (!els.toggleInfoBtn) return;
  els.toggleInfoBtn.textContent = game.infoPanelOpen ? t("toggleInfoHide") : t("toggleInfoShow");
}

function randomBetween(min, max) {
  return Math.random() * (max - min) + min;
}

function getArenaSize() {
  const rect = els.arena.getBoundingClientRect();
  return { width: rect.width, height: rect.height };
}

function getBagSize() {
  if (!els.catchBag) return { width: game.player.width, height: game.player.height };
  const rect = els.catchBag.getBoundingClientRect();
  return {
    width: rect.width || game.player.width,
    height: rect.height || game.player.height
  };
}

function positionBag() {
  if (!els.catchBag) return;
  els.catchBag.style.left = `${game.player.x}px`;
}

function resetBagPosition() {
  const arena = getArenaSize();
  const bag = getBagSize();
  game.player.width = bag.width;
  game.player.height = bag.height;
  game.player.x = Math.max(4, (arena.width - bag.width) / 2);
  positionBag();
}

function clearBagCollected() {
  game.bagStored = [];
  if (els.bagCollected) {
    els.bagCollected.innerHTML = "";
  }
}

function addBottleToBag(type) {
  if (!els.bagCollected) return;
  const chip = document.createElement("span");
  chip.className = `bag-mini-bottle ${type}`;
  els.bagCollected.appendChild(chip);
  game.bagStored.push(type);
  const maxShown = window.innerWidth <= 760 ? 18 : 28;
  while (els.bagCollected.children.length > maxShown) {
    els.bagCollected.removeChild(els.bagCollected.firstChild);
  }
}

function createItem(type) {
  const item = document.createElement("div");
  item.className = `fall-item ${type}`;
  item.dataset.kind = type;
  item.setAttribute("aria-label", type === "bad" ? t("ariaBad") : t("ariaGood"));
  item.innerHTML = `
    <span class="cap" aria-hidden="true"></span>
    <span class="body" aria-hidden="true">
      <span class="item-label">
        <span></span><span></span><span></span>
      </span>
      <span class="chip">${type === "bad" ? "!" : "âœ“"}</span>
    </span>
  `;
  return item;
}

function updateItemAriaLabels() {
  game.items.forEach((item) => {
    item.el.setAttribute("aria-label", item.type === "bad" ? t("ariaBad") : t("ariaGood"));
  });
}

function spawnItem() {
  const arena = getArenaSize();
  const isBad = Math.random() < 0.55;
  const type = isBad ? "bad" : "good";
  const el = createItem(type);
  els.arena.appendChild(el);

  const estimatedWidth = window.innerWidth <= 760 ? 72 : 84;
  const x = randomBetween(4, Math.max(5, arena.width - estimatedWidth - 4));
  const y = -145;
  // Basket control makes the game easier, so start moderate and ramp up more.
  const speed = randomBetween(92, 128) + Math.min(78, game.elapsed * 1.15);
  const drift = randomBetween(-8, 8);
  const rotation = randomBetween(-8, 8);

  const itemObj = {
    id: game.nextId++,
    type,
    x,
    y,
    speed,
    drift,
    rotation,
    el,
    removed: false
  };

  el.style.left = `${x}px`;
  el.style.top = `${y}px`;
  el.style.transform = `rotate(${rotation}deg)`;

  game.items.push(itemObj);
}

function removeItem(item, stateClass) {
  if (item.removed) return;
  item.removed = true;
  if (stateClass) {
    item.el.classList.add(stateClass);
    window.setTimeout(() => item.el.remove(), 210);
  } else {
    item.el.remove();
  }
}

function showScorePopup(x, y, value) {
  const popup = document.createElement("div");
  popup.className = `score-popup ${value >= 0 ? "positive" : "negative"}`;
  popup.textContent =
    value >= 0
      ? formatText(t("scorePopupPlus"), { value })
      : formatText(t("scorePopupMinus"), { value });
  popup.style.left = `${x}px`;
  popup.style.top = `${y}px`;
  els.arena.appendChild(popup);
  window.setTimeout(() => popup.remove(), 720);
}

function changeScore(delta, item) {
  game.score = Math.max(-999, game.score + delta);
  updateStatsUI();
  const rect = els.arena.getBoundingClientRect();
  if (item) {
    showScorePopup(item.x + 40, item.y + 70, delta);
  } else {
    showScorePopup(rect.width / 2, 40, delta);
  }
}

function handleItemCatch(item) {
  if (!game.running || item.removed) return;

  if (item.type === "bad") {
    removeItem(item, "is-hit");
    addBottleToBag(item.type);
    game.combo += 1;

    let gained = 10;
    if (game.combo > 0 && game.combo % 4 === 0) {
      gained += 6;
      showEventFact("factEventCombo");
      const bonus = document.createElement("div");
      bonus.className = "score-popup positive";
      bonus.textContent = formatText(t("comboBonusText"), { value: 6 });
      bonus.style.left = `${item.x + 42}px`;
      bonus.style.top = `${Math.max(30, item.y + 25)}px`;
      els.arena.appendChild(bonus);
      window.setTimeout(() => bonus.remove(), 760);
    } else {
      showEventFact("factEventGood");
    }

    changeScore(gained, item);
  } else {
    removeItem(item, "is-hit");
    addBottleToBag(item.type);
    game.combo = 0;
    changeScore(-5, item);
    showEventFact("factEventBadClick");
  }

  updateStatsUI();
}

function processMisses(item) {
  if (item.type === "bad") {
    game.combo = 0;
    changeScore(-8, item);
    showEventFact("factEventMissBad");
  }
  removeItem(item, "is-missed");
  updateStatsUI();
}

function updatePlayer(delta, arena) {
  const bagWidth = game.player.width;
  let dir = 0;
  if (game.keys.left) dir -= 1;
  if (game.keys.right) dir += 1;
  if (!dir) return;
  const speedProgress = Math.min(1, game.elapsed / 70);
  const currentPlayerSpeed = game.player.speed + speedProgress * 180;
  game.player.x += dir * currentPlayerSpeed * delta;
  game.player.x = Math.max(4, Math.min(arena.width - bagWidth - 4, game.player.x));
  positionBag();
}

function isCaughtByBag(item, arena) {
  const bagTop = arena.height - game.player.height - 10;
  const bagBottom = arena.height - 4;
  const itemWidth = item.el.offsetWidth || (window.innerWidth <= 760 ? 72 : 84);
  const itemHeight = item.el.offsetHeight || 138;
  const itemLeft = item.x;
  const itemRight = item.x + itemWidth;
  const itemBottom = item.y + itemHeight;
  const itemMidX = itemLeft + itemWidth / 2;
  const bagLeft = game.player.x;
  const bagRight = game.player.x + game.player.width;
  const inHorizontal = itemMidX > bagLeft + 6 && itemMidX < bagRight - 6;
  const inVertical = itemBottom >= bagTop && itemBottom <= bagBottom;
  return inHorizontal && inVertical;
}

function cleanupRemovedItems() {
  game.items = game.items.filter((item) => {
    if (!item.removed) return true;
    return item.el.isConnected;
  });
}

function tick(ts) {
  if (!game.running) return;
  if (!game.lastTs) game.lastTs = ts;
  const delta = Math.min(0.05, (ts - game.lastTs) / 1000);
  game.lastTs = ts;

  game.elapsed += delta;
  game.spawnAccumulator += delta;
  game.secondAccumulator += delta;

  // Slightly faster curve with basket controls.
  const progress = Math.min(1, game.elapsed / 70);
  const spawnEvery = 0.88 - progress * 0.42;
  if (game.spawnAccumulator >= spawnEvery) {
    game.spawnAccumulator = 0;
    spawnItem();
  }

  const arena = getArenaSize();
  updatePlayer(delta, arena);
  for (const item of game.items) {
    if (item.removed) continue;
    const itemWidth = item.el.offsetWidth || (window.innerWidth <= 760 ? 72 : 84);
    item.y += item.speed * delta;
    item.x += item.drift * delta;

    if (item.x < 2) {
      item.x = 2;
      item.drift *= -1;
    }
    if (item.x > arena.width - itemWidth - 2) {
      item.x = arena.width - itemWidth - 2;
      item.drift *= -1;
    }

    item.el.style.left = `${item.x}px`;
    item.el.style.top = `${item.y}px`;
    item.el.style.transform = `rotate(${item.rotation + Math.sin(item.y / 45) * 2}deg)`;

    if (isCaughtByBag(item, arena)) {
      handleItemCatch(item);
      continue;
    }

    if (item.y > arena.height + 8) {
      processMisses(item);
    }
  }

  cleanupRemovedItems();

  if (game.secondAccumulator >= 1) {
    const step = Math.floor(game.secondAccumulator);
    game.secondAccumulator -= step;
    game.timeLeft = Math.max(0, game.timeLeft - step);
    updateStatsUI();
    if (game.timeLeft <= 0) {
      endRound();
      return;
    }
  }

  game.rafId = requestAnimationFrame(tick);
}

function scoreTier(score) {
  if (score >= 160) {
    return {
      titleKey: "resultTitleTop",
      gradeKey: "resultGradeTop",
      moodKey: "resultMoodTop",
      theme: "theme-top",
      emoji: "ðŸ†",
      confetti: 18
    };
  }
  if (score >= 100) {
    return {
      titleKey: "resultTitleHigh",
      gradeKey: "resultGradeHigh",
      moodKey: "resultMoodHigh",
      theme: "theme-high",
      emoji: "ðŸŽ‰",
      confetti: 12
    };
  }
  if (score >= 45) {
    return {
      titleKey: "resultTitleMid",
      gradeKey: "resultGradeMid",
      moodKey: "resultMoodMid",
      theme: "theme-mid",
      emoji: "ðŸ‘",
      confetti: 6
    };
  }
  return {
    titleKey: "resultTitleLow",
    gradeKey: "resultGradeLow",
    moodKey: "resultMoodLow",
    theme: "theme-low",
    emoji: "ðŸ•µï¸",
    confetti: 0
  };
}

function clearResultDecorations() {
  if (!els.resultCard) return;
  els.resultCard.classList.remove("theme-low", "theme-mid", "theme-high", "theme-top");
  els.resultCard.querySelectorAll(".result-confetti").forEach((node) => node.remove());
}

function spawnResultConfetti(count) {
  if (!els.resultCard || count <= 0) return;
  const colors = ["#005ca9", "#f4b400", "#d72638", "#0f9d58", "#78b9ff"];
  for (let i = 0; i < count; i += 1) {
    const piece = document.createElement("span");
    piece.className = "result-confetti";
    piece.style.background = colors[i % colors.length];
    piece.style.left = `${18 + Math.random() * 64}%`;
    piece.style.top = `${10 + Math.random() * 8}px`;
    piece.style.setProperty("--dx", `${(Math.random() - 0.5) * 190}px`);
    piece.style.setProperty("--dy", `${44 + Math.random() * 95}px`);
    piece.style.setProperty("--rot", `${(Math.random() - 0.5) * 560}deg`);
    piece.style.animationDelay = `${Math.random() * 120}ms`;
    els.resultCard.appendChild(piece);
  }
}

function refreshResultTexts() {
  const tier = scoreTier(game.score);
  clearResultDecorations();
  if (els.resultCard) els.resultCard.classList.add(tier.theme);
  if (els.resultEmoji) els.resultEmoji.textContent = tier.emoji;
  els.resultTitle.textContent = t(tier.titleKey);
  els.resultScoreText.textContent = formatText(t("resultScoreText"), { score: game.score });
  if (els.resultMoodText) els.resultMoodText.textContent = t(tier.moodKey);
  els.resultGradeText.textContent = t(tier.gradeKey);
  if (!els.resultPanel.hidden) {
    spawnResultConfetti(tier.confetti);
  }
}

function endRound() {
  game.running = false;
  if (game.rafId) {
    cancelAnimationFrame(game.rafId);
    game.rafId = null;
  }

  for (const item of game.items) {
    if (!item.removed) removeItem(item, "is-missed");
  }
  cleanupRemovedItems();

  els.resultPanel.hidden = false;
  refreshResultTexts();
  els.arenaHint.hidden = false;
}

function startRound() {
  resetState();
  game.running = true;
  els.arenaHint.hidden = true;
  setInfoPanelOpen(false);
  showEventFact("factEventStart");
  game.rafId = requestAnimationFrame(tick);
}

function resetRound() {
  resetState();
}

els.startBtn.addEventListener("click", startRound);
els.resetBtn.addEventListener("click", resetRound);
els.playAgainBtn.addEventListener("click", startRound);
if (els.toggleInfoBtn) {
  els.toggleInfoBtn.addEventListener("click", () => {
    setInfoPanelOpen(!game.infoPanelOpen);
  });
}

els.langButtons.forEach((btn) => {
  btn.addEventListener("click", () => setLanguage(btn.dataset.lang));
});

window.addEventListener("keydown", (event) => {
  if (event.key === "ArrowLeft") {
    game.keys.left = true;
    event.preventDefault();
  } else if (event.key === "ArrowRight") {
    game.keys.right = true;
    event.preventDefault();
  }
});

window.addEventListener("keyup", (event) => {
  if (event.key === "ArrowLeft") {
    game.keys.left = false;
  } else if (event.key === "ArrowRight") {
    game.keys.right = false;
  }
});

window.addEventListener("resize", () => {
  const arena = getArenaSize();
  const bag = getBagSize();
  game.player.width = bag.width;
  game.player.height = bag.height;
  game.player.x = Math.max(4, Math.min(arena.width - game.player.width - 4, game.player.x));
  positionBag();
  game.items.forEach((item) => {
    const itemWidth = item.el.offsetWidth || (window.innerWidth <= 760 ? 72 : 84);
    const maxX = Math.max(2, arena.width - itemWidth - 2);
    if (item.x > maxX) item.x = maxX;
    item.el.style.left = `${item.x}px`;
  });
});

let topbarIdleTimer = null;

function hideTopbarIfIdle() {
  if (!els.topbar) return;
  if (window.scrollY > 24) {
    els.topbar.classList.add("is-hidden");
  } else {
    els.topbar.classList.remove("is-hidden");
  }
}

function revealTopbarOnScroll() {
  if (!els.topbar) return;
  els.topbar.classList.remove("is-hidden");
  window.clearTimeout(topbarIdleTimer);
  topbarIdleTimer = window.setTimeout(hideTopbarIfIdle, 700);
}

window.addEventListener("scroll", revealTopbarOnScroll, { passive: true });

setLanguage("en");
resetState();
hideTopbarIfIdle();
